<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>广播式WebSocket</title>
    <!--    附件 stomp支持js-->
    <script src="js/sockjs.min.js"></script>
    <script src="js/stomp.min.js"></script>
    <script src="js/snow.js"></script>
    <script type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="bootstrap/js/bootstrap-paginator.min.js"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="bootstrap/css/dashboard.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/bootstrap/css/bootstrap-theme.css">

</head>
<!--页面加载后 如果原来就有socket对象  就先断开-->
<!--检测浏览器是否支持websocket -->
<noscript><h2 style="color: #e80b0a;">Sorry，浏览器不支持WebSocket</h2></noscript>
<body>
<input type="text" id="name" style="display: none"/>
<!--<nav class="navbar navbar-fixed-top" style="background-color: #e6e6e6">-->
    <!--<div class="container-fluid">-->
        <!--<div class="navbar-header">-->
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"-->
                    <!--aria-expanded="false" aria-controls="navbar">-->
                <!--<span class="sr-only">Toggle navigation</span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
            <!--</button>-->
            <!--<a class="navbar-brand" href="#">IM DEMO</a>-->
        <!--</div>-->
        <!--<div id="navbar" class="navbar-collapse collapse">-->
            <!--<ul class="nav navbar-nav navbar-right">-->
                <!--<li><a href="#" data-toggle="modal" data-target="#myModal"><span class="iconfont">&#xe741;</span></a></li>-->
            <!--</ul>-->
            <!--<form class="navbar-form navbar-right">-->
                <!--<input type="text" class="form-control" placeholder="Search...">-->
            <!--</form>-->
        <!--</div>-->
    <!--</div>-->
<!--</nav>-->
<div class="container-fluid" style="display:flex;
        justify-content: space-between;padding-left: 0px;padding-right: 0px;height: 100%;">
    <div class="left-menu" style="width:65px;height: 100%;border-right-color: #e6e6e6;border-right-style: inset;">
        <ul class="nav nav-stacked">
            <!-- 侧边栏选项 -->
            <li role="presentation" class="active">
                <a href="#" data-toggle="collapse" data-target="#list" id="myhead" style="display:flex;align-items:center;justify-content:center;padding: 5px">

                </a>
            </li>
            <li role="presentation">
                <a href="#" onclick="showFriends();"><span class="iconfont">&#xe7b2;</span></a>
            </li>
            <li role="presentation">
                <a href="#" data-toggle="modal" data-target="#myModal"><span class="iconfont">&#xe742;</span></a>
            </li>
        </ul>
        <ul class="nav nav-stacked" style="position: absolute;bottom: 0px;">
            <!-- 侧边栏选项 -->
            <li role="presentation" class="active">
                <a href="#" data-toggle="collapse" data-target="#list"><span class="iconfont">&#xe6ef;</span></a>
            </li>
        </ul>
    </div>
    <div class="left-menu" style="width:230px;height: 100%;border-right-color: #e6e6e6;border-right-style: inset;">
        <!-- 侧边栏标签页 -->
        <ul class="nav nav-stacked">
            <!-- 侧边栏选项 -->
            <li role="presentation">
                <!-- 选项控制data-target对应的显隐 -->
                <!-- 隐藏的详细菜单 -->
                <ul id="userlist" class="collapse in" style="padding-left: 0px">

                </ul>
            </li>
        </ul>

        <ul class="nav nav-stacked" style="position: absolute;bottom: 0px;">
            <!-- 侧边栏选项 -->
            <li role="presentation">

            </li>
        </ul>
    </div>
    <div class="right-content" style="width:80%;height: 100%;">
        <h3 class="page-header" style="margin:10px 0px;" id="usergroup">

        </h3>

        <div style="width:100%;height:400px; overflow-y:auto;border:1px solid #333;" id="show">

        </div>
        <input type="text" onkeydown="sendName(event)" id="msg" name="msg" class="form-control" placeholder="msg">
        <input type="file" id="exampleInputFile">
        <button type="button" id="senden">发起竞价</button>
    </div>

    <div class="right-content" style="width:230px;height: 100%;">
        <ul class="nav nav-stacked" id="member" style="padding: 5px">

        </ul>
    </div>
</div>
<div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document" style="color: #0f0f0f">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">CREATE GROUP</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="group_name">GROUP_NAME</label>
                        <input type="text" class="form-control" id="group_name" placeholder="group_name">
                    </div>
                    <div class="group_member">
                        <label>GROUP_MEMBER</label>

                    </div>
                    <button type="submit" class="btn btn-primary datasourcelink">ok</button>
                </div>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript">
    $(document).ready(function () {
        getInfo();
        connect();

        userlist();


    });

    $('#myModal').on('show.bs.modal', function (event) {
        $.ajax({
            url: '../userlist',
            dataType: 'json',
            type: 'get',
            data: {},
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                if (data.code == 200) {
                    var str = "";

                    data.data.users.forEach((item, index, data) => {
                        str += '<div class="checkbox">' +
                            '<label>' +
                            '<input  name="usercheckbox" type="checkbox" value="' + item.user_name + '">' +
                            item.nick_name +
                            '</label>' +
                            '</div>';
                    })
                    $(".group_member").html(str);
                }
            },
        });
    })

    $(document).on("click", ".datasourcelink", function () {
        var list = [];

        $(":checkbox[name='usercheckbox']:checked").each(function () {
            list.push($(this).val());
        });

        let object = {};
        object.name = $('#group_name').val();
        object.userlist = list;
        object.type = 4;
        send(JSON.stringify(object));
    });

    $(document).on('change', '.toUser', function () {
        toUser = $('input:radio:checked').val();
        $("#show").html("");
        history(toUser);
    });

    function selectChat(type,username,nickname, e) {
        if(type == 1){
            selectGroup(username, nickname, e)
        }else{
            selectUser(username,nickname, e)
        }
    }

    function selectUser(username,nickname, e) {
        toUser = username;
        $("#show").html("");
        userhistory(username);
        this.type = 2;
        $("#userlist li").removeClass("active");
        $(e).addClass("active");

        $("#usergroup").html(nickname+'<a href="#" style=""><span class="iconfont">&#xe76c;</span></a>');
    }

    function selectGroup(groupid, groupname, e) {
        toGroup = groupid;
        $("#show").html("");
        grouphistory(groupid);
        this.type = 3;
        $("#userlist li").removeClass("active");

        $(e).addClass("active");s

        $("#usergroup").html(groupname+'<a href="#" style=""><span class="iconfont">&#xe76c;</span></a>');
    }

    function showFriends(){
        $.ajax({
            url: '../showfriends',
            dataType: 'json',
            type: 'get',
            data: {},
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                if (data.code == 200) {
                    var str = "";
                    data.data.users.forEach((item, index, data) => {
                        str += '<li onclick="selectChat(2,\'' + item.userName + '\',\'' + item.nickName + '\', this)" style="display: flex;padding: 5px"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="...">' +
                            '<div style=" height:45px;vertical-align:middle;font-size:15px;margin-left: 8px;">' +
                            '<a style="font-size: 15px" href="javascript:void(0)">' + item.nickName + '</a>' +
                            '</div></li>';
                    })
                    $("#userlist").html(str);

                    $("#myhead").html('<img class="media-object" src="'+ myAvater+'" height="45" width="45" alt="..." style="display: inline-block;">');

                }
            },
        });
    }

    $(document).on('change', '#exampleInputFile', function () {
        var files = this.files;
        var formData = new FormData();
        formData.append("file", files[0]);
        $.ajax({
            method: 'POST',
            url: 'upload',
            dataType: 'json',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                if (data.code == 200) {
                    let object = {};
                    var uuid = new Snowflake(1n, 1n, 0n).nextId().toString();
                    object.msgId = uuid;
                    object.type = 3;
                    object.toUserId = toUser;
                    object.msg = data.msg;
                    send(JSON.stringify(object));

                    var str = '<div style="text-align:right">' + object.msg + ' : ' + $("#name").val() + '</div>';
                    $("#show").append(str);
                } else {
                    alert();
                }
            },
            error: function (data) {
                alert();
            }
        });
    });


    let url = "ws://localhost:9091";
    let access_token = getCookie();
    let ws;
    let toUser;
    let myNickName;
    let myAvater;
    let toGroup;
    let type;

    function userhistory(toUser1) {
        $.ajax({
            url: '../history',
            dataType: 'json',
            type: 'get',
            data: {
                "fromUsername": toUser1
            },
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                $("#member").html("");
                data.data.forEach((item, index, data) => {
                    if ($("#name").val() == item.from_id) {
                        var str = '<div style="text-align:right;margin: 3px;"><span>' + item.content + ' : ' + item.nick_name + '</span><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..." style="display: inline-block;"></div>';
                        $("#show").append(str);
                    } else {
                        var str = '<div style="text-align:left;margin: 3px;"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..." style="display: inline-block;"><span>' + item.nick_name + ' : ' + item.content + '</span></div>';
                        $("#show").append(str);
                    }
                })
            }
        });
    }

    function grouphistory(toGroup) {
        $.ajax({
            url: '../message/history',
            dataType: 'json',
            type: 'get',
            data: {
                "groupId": toGroup
            },
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                data.data.history.forEach((item, index, data) => {
                    if ($("#name").val() == item.from_id) {
                        var str = '<div style="text-align:right;margin: 3px;">' + item.content + ' : ' + item.nick_name + '<img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..." style="display: inline-block;"></div>';
                        $("#show").append(str);
                    } else {
                        var str = '<div style="text-align:left;margin: 3px;"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..." style="display: inline-block;">' + item.nick_name + ' : ' + item.content + '</div>';
                        $("#show").append(str);
                    }
                })
                $("#member").html('<li style="display: flex"><input type="text" class="form-control" placeholder="Search..."></li>');
                $("#member").append('<li style="display: flex">MANAGER</li>');
                data.data.group.forEach((item, index, data) => {
                    var str = '<li style="display: flex"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..."><span>' + item.nick_name + '</span></li>';
                    $("#member").append(str);
                })
                $("#member").append('<li style="display: flex">MEMBERS</li>');
                data.data.members.forEach((item, index, data) => {
                    var str = '<li style="display: flex"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="..."><span>' + item.nick_name + '</span></li>';
                    $("#member").append(str);
                })
            }
        });
    }

    function getInfo() {
        $.ajax({
            url: '../getInfo',
            dataType: 'json',
            type: 'get',
            data: {},
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                $("#name").val(data.userName);
                myNickName = data.nickName;
                myAvater = data.avater;
            },
            error: function (data) {
                if (data.status == 401) {
                    alert("请登录");
                    window.location.href = 'http://localhost:8084/login';
                }
            }
        });
    }

    function userlist() {
        $.ajax({
            url: '../userlist',
            dataType: 'json',
            type: 'get',
            data: {},
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                if (data.code == 200) {
                    var str = "";
                    data.data.users.forEach((item, index, data) => {
                        str += ' <li onclick="selectChat('+item.msgtype+',\'' + item.target + '\',\'' + item.name + '\', this)" style="display: flex;padding: 5px"><img class="media-object" src="'+item.avater+'" height="45" width="45" alt="...">' +
                            '<div style=" height:45px;vertical-align:middle;font-size:15px;margin-left: 8px;">' +
                            '<a style="font-size: 15px" href="javascript:void(0)">' + item.name + '</a>' +
                            '<div style="font-size: 10px">' + item.content + '</div>' +
                            '</div></li>';
                    })
                    $("#userlist").html(str);

                    $("#myhead").html('<img class="media-object" src="'+ myAvater+'" height="45" width="45" alt="..." style="display: inline-block;">');

                }
            },
        });
    }

    function init() {

        ws.onopen = function (evt) {
            console.log("WebSocket 连接成功!!");
            let object = {};
            object.type = 1;
            send(JSON.stringify(object));
        };

        ws.onmessage = function (event) {
            let data = JSON.parse(event.data);

            var show = document.getElementById("show");
            if (data.status == 200) {
                if (data.type == 1) {
                    show.innerHTML += data.params.message + "<br/>";
                } else if (data.type == 2) {
                    show.innerHTML += '<div style="text-align:left;margin: 3px;"><img class="media-object" src="'+ data.params.avater+'" height="45" width="45" alt="..." style="display: inline-block;">'+data.params.nickName + ' : ' + data.params.message + "</div><br/>";
                    var chatlist = document.getElementById('show');
                    chatlist.scrollTop = chatlist.scrollHeight;
                } else if (data.type == 4){
                    $('#myModal').modal('toggle');
                    userlist();
                }else{
                    show.innerHTML += '<div style="text-align:left;margin: 3px;"><img class="media-object" src="\'+ data.params.avater+\'" height="45" width="45" alt="..." style="display: inline-block;">'+data.params.fromUser + ' : ' + data.params.message + "<br/>";
                }
            }
        }
    }

    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (ws.readyState === ws.OPEN) {
            ws.send(message);
        } else {
            alert("WebSocket连接没有建立成功！！");
        }
    }

    function creategroup() {
        $.ajax({
            url: '../getInfo',
            dataType: 'json',
            type: 'get',
            data: {},
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function (data) {
                $("#name").val(data.name);
            },
            error: function (data) {
                if (data.status == 401) {
                    alert("请登录");
                    window.location.href = 'http://localhost:8084/login';
                }
            }
        });
    }

    //点击连接 时候触发的事件 【这个函数 除了更改自己url 或者添加自己的业务逻辑  一般不用修改 】
    function connect() {
        try {
            ws = new WebSocket(url + "/" + access_token);
            init();
        } catch (e) {
            console.log(e);
        }
    }

    function getCookie() {
        var token = "";
        var cookie_name = "access_token";
        var allcookies = document.cookie;
        var cookie_pos = allcookies.indexOf(cookie_name);
        if (cookie_pos != -1) {
            cookie_pos += cookie_name.length + 1;
            var cookie_end = allcookies.indexOf(";", cookie_pos);
            if (cookie_end == -1) {
                cookie_end = allcookies.length;
            }
            token = unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return token
    }

    //断开连接
    function disconnect() {
        ws.close()
        document.getElementById("show").innerHTML = "";
        document.getElementById("show").innerHTML += "断开连接<br/>";
        document.getElementById("msg").value = "";
    }

    //发送私聊
    function sendName(event) {
        var evt = window.event || e;
        if (evt.keyCode == 13) {

            if (this.type == 2) {
                let object = {};
                var uuid = new Snowflake(1n, 1n, 0n).nextId().toString();
                object.msgId = uuid;
                object.type = this.type;
                object.toUserId = toUser;
                object.msg = $("#msg").val();
                send(JSON.stringify(object));

                var str = '<div style="text-align:right;margin: 3px;">' + object.msg + ' : ' + myNickName + '<img class="media-object" src="'+ myAvater+'" height="45" width="45" alt="..." style="display: inline-block;"></div>';
                $("#show").append(str);

                var chatlist = document.getElementById('show');
                chatlist.scrollTop = chatlist.scrollHeight;

                $('#msg').val("");
            } else {
                let object = {};
                var uuid = new Snowflake(1n, 1n, 0n).nextId().toString();
                object.groupId = toGroup;
                object.msgId = uuid;
                object.type = this.type;
                object.msg = $("#msg").val();
                send(JSON.stringify(object));

                var str = '<div style="text-align:right;margin: 3px;">' + object.msg + ' : ' + myNickName + '<img class="media-object" src="'+ myAvater+'" height="45" width="45" alt="..." style="display: inline-block;"></div>';
                $("#show").append(str);

                var chatlist = document.getElementById('show');
                chatlist.scrollTop = chatlist.scrollHeight;

                $('#msg').val("");
            }
        }

    }

    //展示 返回的消息
    function showResponse(message) {
    }
</script>
</body>
</html>